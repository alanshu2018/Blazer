#coding:

# Preprocess train_data
import pandas as pd
import numpy as np

Ver = "1.0"

#
# Make some big number in the examples small as percentage
#
#log scale click and download count
import sys
import math


click_bins = [6.0, 24.0, 42.0, 60.0, 78.0, 96.0, 114.0, 132.0, 150.0, 168.0, 186.0, 204.0, 222.0, 240.0, 258.0, 276.0, 294.0, 312.0, 330.0, 348.0, 366.0, 384.0, 402.0, 420.0, 438.0, 456.0, 474.0, 492.0, 510.0, 528.0, 546.0, 564.0, 582.0, 600.0, 618.0, 636.0, 654.0, 672.0, 690.0, 708.0, 726.0, 744.0, 762.0, 780.0, 798.0, 816.0, 834.0, 852.0, 870.0, 888.0, 906.0, 924.0, 942.0, 960.0, 978.0, 996.0, 1014.0, 1032.0, 1050.0, 1068.0, 1086.0, 1104.0, 1122.0, 1140.0, 1158.0, 1176.0, 1194.0, 1212.0, 1230.0, 1248.0, 1266.0, 1284.0, 1302.0, 1320.0, 1338.0, 1356.0, 1374.0, 1392.0, 1410.0, 1428.0, 1446.0, 1464.0, 1482.0, 1500.0, 1518.0, 1536.0, 1554.0, 1572.0, 1590.0, 1608.0, 1626.0, 1644.0, 1662.0, 1680.0, 1698.0, 1716.0, 1734.0, 1752.0, 1770.0, 1788.0, 1806.0, 1824.0, 1842.0, 1860.0, 1878.0, 1896.0, 1914.0, 1932.0, 1950.0, 1968.0, 1986.0, 2004.0, 2022.0, 2040.0, 2058.0, 2076.0, 2094.0, 2112.0, 2130.0, 2148.0, 2166.0, 2184.0, 2202.0, 2220.0, 2238.0, 2256.0, 2274.0, 2292.0, 2310.0, 2328.0, 2346.0, 2364.0, 2382.0, 2400.0, 2418.0, 2436.0, 2454.0, 2472.0, 2490.0, 2508.0, 2526.0, 2544.0, 2562.0, 2580.0, 2598.0, 2616.0, 2634.0, 2652.0, 2670.0, 2688.0, 2706.0, 2724.0, 2742.0, 2760.0, 2778.0, 2796.0, 2814.0, 2832.0, 2850.0, 2868.0, 2886.0, 2904.0, 2922.0, 2940.0, 2958.0, 2976.0, 2994.0, 3012.0, 3030.0, 3048.0, 3066.0, 3084.0, 3102.0, 3120.0, 3138.0, 3156.0, 3174.0, 3192.0, 3210.0, 3228.0, 3246.0, 3264.0, 3282.0, 3300.0, 3318.0, 3336.0, 3354.0, 3372.0, 3390.0, 3408.0, 3426.0, 3444.0, 3462.0, 3480.0, 3498.0, 3516.0, 3534.0, 3552.0, 3570.0, 3588.0, 3606.0, 3624.0, 3642.0, 3660.0, 3678.0, 3696.0, 3714.0, 3732.0, 3750.0, 3768.0, 3786.0, 3804.0, 3822.0, 3840.0, 3858.0, 3876.0, 3894.0, 3912.0, 3930.0, 3948.0, 3966.0, 3984.0, 4002.0, 4020.0, 4038.0, 4056.0, 4074.0, 4092.0, 4110.0, 4128.0, 4146.0, 4164.0, 4182.0, 4200.0, 4218.0, 4236.0, 4254.0, 4272.0, 4290.0, 4308.0, 4326.0, 4344.0, 4362.0, 4380.0, 4398.0, 4416.0, 4434.0, 4452.0, 4470.0, 4488.0, 4506.0, 4524.0, 4542.0, 4560.0, 4578.0, 4596.0, 4614.0, 4632.0, 4650.0, 4668.0, 4686.0, 4704.0, 4722.0, 4740.0, 4759.0, 4777.0, 4795.0, 4814.0, 4832.0, 4850.0, 4868.0, 4886.0, 4904.0, 4922.0, 4940.0, 4958.0, 4976.0, 4996.0, 5014.0, 5032.0, 5050.0, 5068.0, 5086.0, 5104.0, 5122.0, 5140.0, 5158.0, 5177.0, 5195.0, 5213.0, 5231.0, 5249.0, 5267.0, 5285.0, 5303.0, 5321.0, 5340.0, 5358.0, 5376.0, 5394.0, 5412.0, 5430.0, 5448.0, 5466.0, 5484.0, 5502.0, 5520.0, 5538.0, 5556.0, 5575.0, 5593.0, 5611.0, 5629.0, 5648.0, 5666.0, 5684.0, 5702.0, 5720.0, 5739.0, 5757.0, 5775.0, 5793.0, 5812.0, 5830.0, 5849.0, 5869.0, 5887.0, 5907.0, 5927.0, 5945.0, 5963.0, 5982.0, 6002.0, 6020.0, 6038.0, 6057.0, 6077.0, 6096.0, 6114.0, 6133.0, 6151.0, 6170.0, 6188.0, 6206.0, 6224.0, 6242.0, 6260.0, 6279.0, 6299.0, 6320.0, 6338.0, 6358.0, 6376.0, 6394.0, 6413.0, 6435.0, 6454.0, 6474.0, 6492.0, 6511.0, 6530.0, 6550.0, 6569.0, 6589.0, 6608.0, 6627.0, 6648.0, 6669.0, 6688.0, 6710.0, 6730.0, 6748.0, 6768.0, 6791.0, 6809.0, 6827.0, 6849.0, 6868.0, 6886.0, 6905.0, 6924.0, 6942.0, 6963.0, 6982.0, 7003.0, 7024.0, 7044.0, 7066.0, 7089.0, 7110.0, 7129.0, 7147.0, 7168.0, 7190.0, 7212.0, 7233.0, 7251.0, 7269.0, 7288.0, 7308.0, 7329.0, 7349.0, 7367.0, 7390.0, 7409.0, 7430.0, 7449.0, 7468.0, 7491.0, 7514.0, 7534.0, 7554.0, 7574.0, 7594.0, 7616.0, 7637.0, 7657.0, 7679.0, 7698.0, 7719.0, 7743.0, 7764.0, 7784.0, 7805.0, 7826.0, 7848.0, 7869.0, 7888.0, 7909.0, 7930.0, 7951.0, 7970.0, 7989.0, 8010.0, 8030.0, 8052.0, 8073.0, 8093.0, 8115.0, 8137.0, 8157.0, 8179.0, 8201.0, 8219.0, 8239.0, 8258.0, 8278.0, 8300.0, 8321.0, 8341.0, 8361.0, 8384.0, 8402.0, 8421.0, 8442.0, 8462.0, 8481.0, 8502.0, 8523.0, 8542.0, 8562.0, 8581.0, 8599.0, 8624.0, 8646.0, 8667.0, 8686.0, 8709.0, 8732.0, 8755.0, 8776.0, 8796.0, 8821.0, 8842.0, 8863.0, 8882.0, 8905.0, 8924.0, 8948.0, 8967.0, 8987.0, 9006.0, 9027.0, 9047.0, 9070.0, 9095.0, 9119.0, 9142.0, 9163.0, 9184.0, 9204.0, 9224.0, 9246.0, 9266.0, 9287.0, 9307.0, 9329.0, 9348.0, 9367.0, 9387.0, 9411.0, 9432.0, 9453.0, 9477.0, 9500.0, 9521.0, 9548.0, 9570.0, 9593.0, 9616.0, 9638.0, 9660.0, 9684.0, 9703.0, 9722.0, 9752.0, 9775.0, 9797.0, 9824.0, 9846.0, 9866.0, 9891.0, 9912.0, 9942.0, 9963.0, 9984.0, 10006.0, 10027.0, 10051.0, 10076.0, 10100.0, 10122.0, 10144.0, 10165.0, 10194.0, 10217.0, 10240.0, 10263.0, 10289.0, 10308.0, 10328.0, 10353.0, 10374.0, 10404.0, 10423.0, 10448.0, 10475.0, 10498.0, 10517.0, 10543.0, 10569.0, 10593.0, 10624.0, 10653.0, 10682.0, 10704.0, 10736.0, 10766.0, 10790.0, 10818.0, 10838.0, 10864.0, 10891.0, 10910.0, 10933.0, 10958.0, 10988.0, 11015.0, 11041.0, 11066.0, 11090.0, 11112.0, 11141.0, 11168.0, 11189.0, 11215.0, 11242.0, 11264.0, 11294.0, 11327.0, 11354.0, 11384.0, 11404.0, 11434.0, 11465.0, 11495.0, 11521.0, 11553.0, 11579.0, 11612.0, 11636.0, 11666.0, 11701.0, 11742.0, 11770.0, 11808.0, 11833.0, 11872.0, 11900.0, 11931.0, 11970.0, 12008.0, 12043.0, 12082.0, 12113.0, 12144.0, 12175.0, 12208.0, 12242.0, 12282.0, 12326.0, 12357.0, 12393.0, 12428.0, 12464.0, 12500.0, 12539.0, 12578.0, 12616.0, 12656.0, 12692.0, 12737.0, 12769.0, 12798.0, 12823.0, 12856.0, 12892.0, 12929.0, 12968.0, 12997.0, 13030.0, 13062.0, 13095.0, 13136.0, 13164.0, 13192.0, 13223.0, 13250.0, 13282.0, 13311.0, 13344.0, 13381.0, 13413.0, 13448.0, 13480.0, 13509.0, 13548.0, 13595.0, 13630.0, 13667.0, 13702.0, 13740.0, 13769.0, 13800.0, 13831.0, 13858.0, 13896.0, 13928.0, 13961.0, 13996.0, 14027.0, 14059.0, 14086.0, 14115.0, 14147.0, 14172.0, 14209.0, 14244.0, 14272.0, 14303.0, 14339.0, 14368.0, 14409.0, 14444.0, 14481.0, 14512.0, 14537.0, 14569.0, 14603.0, 14641.0, 14683.0, 14723.0, 14754.0, 14796.0, 14833.0, 14882.0, 14911.0, 14940.0, 14977.0, 15017.0, 15053.0, 15096.0, 15127.0, 15162.0, 15197.0, 15229.0, 15267.0, 15304.0, 15339.0, 15377.0, 15409.0, 15436.0, 15468.0, 15500.0, 15527.0, 15558.0, 15591.0, 15627.0, 15659.0, 15699.0, 15731.0, 15761.0, 15787.0, 15814.0, 15846.0, 15878.0, 15908.0, 15941.0, 15962.0, 15993.0, 16028.0, 16061.0, 16089.0, 16129.0, 16161.0, 16188.0, 16217.0, 16245.0, 16276.0, 16313.0, 16345.0, 16386.0, 16417.0, 16452.0, 16485.0, 16517.0, 16549.0, 16582.0, 16613.0, 16642.0, 16679.0, 16722.0, 16754.0, 16800.0, 16838.0, 16870.0, 16916.0, 16961.0, 17016.0, 17074.0, 17134.0, 17190.0, 17245.0, 17296.0, 17349.0, 17398.0, 17442.0, 17492.0, 17557.0, 17621.0, 17678.0, 17729.0, 17808.0, 17878.0, 17933.0, 17997.0, 18064.0, 18109.0, 18158.0, 18206.0, 18287.0, 18336.0, 18382.0, 18448.0, 18526.0, 18589.0, 18660.0, 18722.0, 18770.0, 18820.0, 18880.0, 18958.0, 19015.0, 19078.0, 19153.0, 19210.0, 19272.0, 19324.0, 19392.0, 19475.0, 19552.0, 19628.0, 19698.0, 19763.0, 19829.0, 19894.0, 19959.0, 20065.0, 20134.0, 20186.0, 20277.0, 20366.0, 20454.0, 20517.0, 20605.0, 20682.0, 20776.0, 20874.0, 20953.0, 21037.0, 21127.0, 21262.0, 21351.0, 21486.0, 21598.0, 21721.0, 21840.0, 21962.0, 22055.0, 22170.0, 22309.0, 22425.0, 22512.0, 22630.0, 22767.0, 22905.0, 23054.0, 23181.0, 23370.0, 23476.0, 23631.0, 23788.0, 23924.0, 24034.0, 24208.0, 24436.0, 24640.0, 24734.0, 24899.0, 25031.0, 25137.0, 25250.0, 25404.0, 25603.0, 25719.0, 25920.0, 26073.0, 26202.0, 26437.0, 26652.0, 26846.0, 27088.0, 27311.0, 27515.0, 27694.0, 27932.0, 28098.0, 28268.0, 28503.0, 28733.0, 28888.0, 29189.0, 29427.0, 29656.0, 29842.0, 30105.0, 30356.0, 30623.0, 30899.0, 31208.0, 31403.0, 31549.0, 31746.0, 32002.0, 32248.0, 32490.0, 32669.0, 32860.0, 33117.0, 33393.0, 33729.0, 33911.0, 34263.0, 34557.0, 34792.0, 35068.0, 35366.0, 35659.0, 36184.0, 36572.0, 36984.0, 37336.0, 37655.0, 37968.0, 38221.0, 38472.0, 38792.0, 39025.0, 39257.0, 39437.0, 39684.0, 40146.0, 40614.0, 40986.0, 41576.0, 41932.0, 42470.0, 43068.0, 43604.0, 44059.0, 44499.0, 44918.0, 45672.0, 46224.0, 47013.0, 47703.0, 48271.0, 48824.0, 49453.0, 50078.0, 50799.0, 51762.0, 52616.0, 53910.0, 54826.0, 55750.0, 56437.0, 57174.0, 58026.0, 58821.0, 59813.0, 60947.0, 62279.0, 63174.0, 64316.0, 65280.0, 67675.0, 68888.0, 70022.0, 71085.0, 73140.0, 74870.0, 76119.0, 77466.0, 79297.0, 80770.0, 82436.0, 83639.0, 85976.0, 88463.0, 90027.0, 91684.0, 94896.0, 98646.0, 101433.0, 104473.0, 106440.0, 110172.0, 113455.0, 115631.0, 118694.0, 123290.0, 126315.0, 129578.0, 133876.0, 138042.0, 142207.0, 145147.0, 149323.0, 153903.0, 158916.0, 162550.0, 168480.0, 171246.0, 176873.0, 185885.0, 194406.0, 206512.0, 213394.0, 223038.0, 232279.0, 243204.0, 256882.0, 268047.0, 282804.0, 299103.0, 317156.0, 327672.0, 343250.0, 359524.0, 374181.0, 399984.0, 431865.0, 459066.0, 482786.0, 514375.0, 552909.0, 587097.0, 643008.0, 679861.0, 716411.0, 767949.0, 809723.0, 865592.0, 935200.0, 1020121.0, 1156169.0, 1249827.0, 1333734.0, 1479377.0, 1736408.0, 1935777.0, 2448710.0, 2711240.0, 3268868.0, 3873319.0, 4692438.0, 5796274.0, 10027169.0, 44181914.0]
download_bins = [0.0, 4.0, 8.0, 12.0, 16.0, 20.0, 24.0, 28.0, 32.0, 36.0, 40.0, 44.0, 48.0, 52.0, 56.0, 60.0, 64.0, 68.0, 72.0, 76.0, 80.0, 84.0, 88.0, 92.0, 96.0, 100.0, 104.0, 108.0, 112.0, 116.0, 120.0, 124.0, 128.0, 132.0, 136.0, 140.0, 144.0, 148.0, 152.0, 156.0, 160.0, 164.0, 168.0, 172.0, 176.0, 180.0, 184.0, 188.0, 192.0, 197.0, 201.0, 205.0, 209.0, 213.0, 218.0, 223.0, 227.0, 231.0, 235.0, 239.0, 244.0, 248.0, 254.0, 258.0, 263.0, 268.0, 272.0, 276.0, 284.0, 291.0, 296.0, 304.0, 308.0, 315.0, 320.0, 327.0, 332.0, 339.0, 343.0, 349.0, 355.0, 360.0, 365.0, 372.0, 377.0, 381.0, 385.0, 389.0, 395.0, 401.0, 407.0, 412.0, 420.0, 430.0, 437.0, 449.0, 454.0, 465.0, 472.0, 483.0, 487.0, 492.0, 504.0, 508.0, 517.0, 525.0, 534.0, 542.0, 548.0, 553.0, 562.0, 570.0, 576.0, 582.0, 590.0, 601.0, 610.0, 615.0, 621.0, 628.0, 644.0, 652.0, 664.0, 678.0, 682.0, 689.0, 700.0, 708.0, 716.0, 727.0, 739.0, 749.0, 754.0, 764.0, 771.0, 779.0, 809.0, 823.0, 842.0, 852.0, 868.0, 881.0, 895.0, 903.0, 928.0, 959.0, 995.0, 1010.0, 1026.0, 1041.0, 1059.0, 1080.0, 1105.0, 1128.0, 1149.0, 1173.0, 1200.0, 1230.0, 1255.0, 1294.0, 1324.0, 1349.0, 1383.0, 1418.0, 1459.0, 1471.0, 1504.0, 1537.0, 1577.0, 1613.0, 1661.0, 1752.0, 1812.0, 1834.0, 1859.0, 1909.0, 1985.0, 2035.0, 2048.0, 2094.0, 2172.0, 2214.0, 2224.0, 2261.0, 2285.0, 2314.0, 2348.0, 2353.0, 2401.0, 2454.0, 2544.0, 2606.0, 2640.0, 2726.0, 2830.0, 2926.0, 2978.0, 3247.0, 3503.0, 3668.0, 3869.0, 4125.0, 4262.0, 4546.0, 4956.0, 5065.0, 5289.0, 5486.0, 5560.0, 5661.0, 5707.0, 5891.0, 6065.0, 6264.0, 6675.0, 6943.0, 7156.0, 8198.0, 9477.0, 10272.0, 11061.0, 11615.0, 12687.0, 13115.0, 16321.0, 18740.0, 19534.0, 25885.0, 27263.0, 33176.0, 38039.0, 42469.0, 61049.0, 79162.0, 101817.0]

print(len(click_bins))
print(len(download_bins))
sys.exit(-1)

def search(num, bins, low, high):
    low_num = bins[low]
    high_num = bins[high]
    if num <= low_num:
        return low
    if num > high_num:
        return high + 1
    if num == high_num:
        return high
    if high - low == 1:
        if num <= high_num:
            return high

    mid = int((low + high)/2)
    mid_num = bins[mid]
    if mid_num > num:
        return search(num, bins, low, mid)
    elif mid_num == num:
        return mid
    else:
        return search(num,bins, mid, high)

def get_bin_num(num, bins):
    low = 0
    high = len(bins)-1

    num = search(num, bins, low, high)
    return num

#fn = sys.argv[1] #"data/train_feature_norm_v1.csv"
def preprocess_file(fn,fn1):
    #fn = "data/dev1_feature_norm.simple.csv"
    fout = open(fn1,"w")
    idx = 0
    for line in open(fn):
        idx += 1
        if idx == 1: # copy header
            fout.write(line)
            continue
        #if idx > 100:
        #    break
        flds = line.strip().split(",")
        #if len(flds) < 13:
        #    continue
        #print("line={}".format(line.strip()))
        flds0 = flds[8:11] + flds[17:20] + flds[26:48]
        #print("flds0={}".format(','.join(flds0)))
        flds1 = []
        flds2 = []
        for i in range(len(flds0)):
            if (i+1) % 3==0:
                flds2.append(flds0[i])
            else:
                if flds0[i] == "0":
                    flds1.append("0")
                else:
                    if (i+1) %3 == 1:
                        num = get_bin_num(float(flds0[i]),download_bins)
                        flds1.append("%d"%(num))
                    else:
                        num = get_bin_num(float(flds0[i]),click_bins)
                        flds1.append("%d"%(num))

        hour_dist = flds[11:17] + flds[20:26]
        #print("flds1={}".format(','.join(flds1)))
        #print("flds2={}".format(','.join(flds2)))
        flds = flds[0:8] + flds1 + flds2 + hour_dist
        fout.write(",".join(flds)+"\n")
    fout.close()


preprocess_file("data/dev1_feature_norm.simple.csv","data/dev1_feature_norm.simple.v3.csv")
preprocess_file("data/dev2_feature_norm.simple.csv","data/dev2_feature_norm.simple.v3.csv")
preprocess_file("data/test_feature_norm.simple.csv","data/test_feature_norm.simple.v3.csv")
preprocess_file("data/train_feature_norm.simple.small.csv","data/train_feature_norm.simple.small.v3.csv")
preprocess_file("data/train_feature_norm.simple.csv","data/train_feature_norm.simple.v3.csv")
